<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employer Dashboard - Job Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f9fafb; }
    .typing-container {
      font-size: 1.5rem;
      font-weight: bold;
      color: #0d6efd;
      white-space: nowrap;
    }

    .cursor {
      display: inline-block;
      width: 2px;
      height: 1.5rem;
      background-color: #0d6efd;
      margin-left: 2px;
      animation: blink 0.7s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    
    .scrolling-wrapper {
      display: flex;
      overflow-x: auto;
      gap: 1rem;
      padding-bottom: 1rem;
      padding-top: 1rem;
      scroll-behavior: smooth;
    }
    .scrolling-wrapper::-webkit-scrollbar {
      display: none;
    }
    .scrolling-wrapper-container {
      position: relative;
    }
    .arrow-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 2rem;
      color: #0d6efd;
      cursor: pointer;
      z-index: 10;
    }
    .arrow-btn-left {
      left: -30px;
    }
    .arrow-btn-right {
      right: -30px;
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <!-- Topbar -->
  <div class="row">
    <div class="col-12 d-flex justify-content-between align-items-center p-4 bg-white border-bottom">
      <h2 class="typing-container">
        Welcome, <span id="employerName"></span>!<span id="cursor" class="cursor"></span>
      </h2>
      <div class="d-flex">
        <button class="btn btn-outline-primary me-2" onclick="goToProfile()">Profile</button>
        <button class="btn btn-outline-dark" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div class="row p-4">
    <div class="col-md-6 mb-4">
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold">Active Job Postings</h3>
        <p class="text-3xl font-bold mt-2" id="activeJobCount">0</p>
        <p class="text-sm text-gray-500">Your current active job listings</p>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold">New Applications</h3>
        <p class="text-3xl font-bold mt-2" id="newApplicationsCount">0</p>
        <p class="text-sm text-gray-500">Total applications received</p>
      </div>
    </div>
  </div>

  <!-- Post Job Section -->
  <div class="row p-4">
    <div class="col-12">
      <h3 class="mb-4">Post a New Job</h3>
      <form id="post-job-form" class="bg-white p-4 rounded-lg shadow mb-4">
        <input required name="title" placeholder="Job Title" class="form-control mb-2">
        <textarea required name="description" placeholder="Job Description" class="form-control mb-2"></textarea>
        <input required name="location" placeholder="Location" class="form-control mb-2">
        <input required name="salary" placeholder="Salary" class="form-control mb-2">
        <input required name="experience" placeholder="Required Experience (e.g., 2-3 years)" class="form-control mb-2">
        <button class="btn btn-primary" type="submit">Post Job</button>
      </form>
    </div>
  </div>

  <!-- Job Postings Section -->
  <div class="row p-4">
    <div class="col-12">
      <h3 class="mb-4">My Posted Jobs</h3>
      <div class="scrolling-wrapper-container" style="position:relative;">
        <button class="arrow-btn arrow-btn-left" onclick="scrollPostedJobsLeft()">&#8592;</button>
        <div id="posted-jobs" class="scrolling-wrapper"></div>
        <button class="arrow-btn arrow-btn-right" onclick="scrollPostedJobsRight()">&#8594;</button>
      </div>
    </div>
  </div>

  <!-- Applications Section -->
  <div class="row p-4">
    <div class="col-12">
      <h3 class="mb-4">Applications</h3>
      <div id="applications" class="row"></div>
    </div>
  </div>

</div>

<script>
  // ✅ AUTH CHECK
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('userRole');
  if (!token || role !== 'employer') {
    window.location.href = 'login.html';
  }

  // ✅ Display employer's name from localStorage with typing effect
  const employerName = localStorage.getItem('userName') || "Employer";
  const nameElement = document.getElementById('employerName');
  let i = 0;
  
  function typeWriter() {
    if (i < employerName.length) {
      nameElement.textContent += employerName.charAt(i);
      i++;
      setTimeout(typeWriter, 100);
    }
  }
  
  typeWriter();

  // ✅ Logout function
  function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('userRole');
    localStorage.removeItem('userName');
    window.location.href = 'index.html';
  }

  // ✅ Profile navigation
  function goToProfile() {
    window.location.href = 'employer-profile.html';
  }

  // ✅ Post Job
  document.getElementById('post-job-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const body = {
      title: form.title.value,
      description: form.description.value,
      location: form.location.value,
      salary: form.salary.value,
      experience: form.experience.value
    };

    try {
      const response = await fetch('http://localhost:5000/api/jobs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        throw new Error('Failed to post job');
      }

      form.reset();
      loadJobs();
    } catch (error) {
      alert('Error posting job: ' + error.message);
    }
  });

  // ✅ Load Posted Jobs
  async function loadJobs() {
    try {
      const res = await fetch('http://localhost:5000/api/jobs/dashboard', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const jobs = await res.json();

      if (!Array.isArray(jobs)) {
        document.getElementById('posted-jobs').innerHTML = `<div class='alert alert-danger'>Error loading jobs: ${jobs.message || 'Unknown error'}</div>`;
        return;
      }

      document.getElementById('posted-jobs').innerHTML = jobs.map((job, i) => `
        <div class="card job-card p-3" style="min-width: 280px; max-width: 320px;">
          <div class="card-body">
            <h5 class="card-title">${job.title}</h5>
            <p class="card-text">${job.description}</p>
            <div class="job-details">
              <p><strong>Location:</strong> ${job.location}</p>
              <p><strong>Salary:</strong> ${job.salary}</p>
              <p><strong>Experience Required:</strong> ${job.experience}</p>
            </div>
          </div>
        </div>
      `).join('');

      // Update the active job count
      document.getElementById('activeJobCount').textContent = jobs.length;

      // Load applications for all jobs
      loadAllApplications(jobs.map(job => job._id));
    } catch (error) {
      console.error('Error loading jobs:', error);
    }
  }

  // Load applications for all jobs
  async function loadAllApplications(jobIds) {
    try {
      let allApplications = [];
      for (const jobId of jobIds) {
        const response = await fetch(`http://localhost:5000/api/applications/job/${jobId}/applications`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        allApplications = [...allApplications, ...data.applications];
      }
      
      const applicationsContainer = document.getElementById('applications');
      if (allApplications.length === 0) {
        applicationsContainer.innerHTML = `
          <div class="col-12">
            <div class="alert alert-info">No applications received yet.</div>
          </div>
        `;
        document.getElementById('newApplicationsCount').textContent = '0';
        return;
      }

      applicationsContainer.innerHTML = `
        <div class="col-12">
          <div class="row" id="applicationsGrid">
            ${allApplications.map(app => `
              <div class="col-md-4 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">${app.user.name}</h5>
                    <p class="card-text"><strong>Applied For:</strong> ${app.job.title}</p>
                    <p class="card-text"><strong>Email:</strong> ${app.user.email}</p>
                    <p class="card-text">
                      <strong>Status:</strong> 
                      <span class="badge ${getStatusBadgeClass(app.status)}">${app.status}</span>
                    </p>
                    <div class="form-group mb-3">
                      <label>Update Status:</label>
                      <select class="form-control" onchange="updateStatus('${app._id}', this.value)">
                        <option value="">Select Status</option>
                        <option value="Applied" ${app.status === 'Applied' ? 'selected' : ''}>Applied</option>
                        <option value="Under Review" ${app.status === 'Under Review' ? 'selected' : ''}>Under Review</option>
                        <option value="Shortlisted" ${app.status === 'Shortlisted' ? 'selected' : ''}>Shortlisted</option>
                        <option value="Accepted" ${app.status === 'Accepted' ? 'selected' : ''}>Accepted</option>
                        <option value="Rejected" ${app.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                      </select>
                    </div>
                    <button class="btn btn-primary w-100 mb-2" onclick="viewResume('${app._id}')">View Resume</button>
                    ${app.statusUpdatedBy ? 
                      `<p class="text-muted small mb-0">Last updated by ${app.statusUpdatedBy.name} on ${new Date(app.statusUpdatedAt).toLocaleDateString()}</p>` 
                      : ''}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // Update the applications count in the dashboard
      document.getElementById('newApplicationsCount').textContent = allApplications.length;
    } catch (error) {
      console.error('Error loading applications:', error);
      document.getElementById('applications').innerHTML = `
        <div class="col-12">
          <div class="alert alert-danger">Error loading applications. Please try again.</div>
        </div>
      `;
    }
  }

  // Update application status
  async function updateStatus(applicationId, status) {
    try {
      const response = await fetch(`http://localhost:5000/api/applications/status/${applicationId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ status })
      });

      if (response.ok) {
        alert('Status updated successfully');
        // Reload all applications
        const jobs = await (await fetch('http://localhost:5000/api/jobs/dashboard', {
          headers: { 'Authorization': `Bearer ${token}` }
        })).json();
        loadAllApplications(jobs.map(job => job._id));
      } else {
        const data = await response.json();
        alert(data.message || 'Error updating status');
      }
    } catch (error) {
      console.error('Error updating status:', error);
      alert('Error updating status');
    }
  }

  // View resume
  async function viewResume(applicationId) {
    try {
      const response = await fetch(`http://localhost:5000/api/applications/resume/${applicationId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        const data = await response.json();
        window.open(`http://localhost:5000/${data.resumePath}`, '_blank');
      } else {
        const data = await response.json();
        alert(data.message || 'Error accessing resume');
      }
    } catch (error) {
      console.error('Error viewing resume:', error);
      alert('Error viewing resume');
    }
  }

  function getStatusBadgeClass(status) {
    switch(status) {
      case 'Applied': return 'bg-primary';
      case 'Under Review': return 'bg-info';
      case 'Shortlisted': return 'bg-warning';
      case 'Accepted': return 'bg-success';
      case 'Rejected': return 'bg-danger';
      default: return 'bg-secondary';
    }
  }

  function scrollPostedJobsLeft() {
    document.getElementById('posted-jobs').scrollBy({ left: -300, behavior: 'smooth' });
  }
  function scrollPostedJobsRight() {
    document.getElementById('posted-jobs').scrollBy({ left: 300, behavior: 'smooth' });
  }

  loadJobs();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
